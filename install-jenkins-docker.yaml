--- 
- name: Get server IP 
  hosts: localhost 
  gather_facts: false
  vars_files:
  - jenkins-vars
  tasks:
  - name: Get public IP address of the ec2 instance
    amazon.aws.ec2_instance_info:
      region: "{{ region }}"
      filters:
        "tag:Name": "jenkins-server"
    register: ec2_result
  
# Preparing Jenkins Server by installing Docker
- name: Preapre server for Jenkins
  hosts: "{{ hostvars['localhost']['ec2_result'].instances[0].public_ip_address }}"
  become: yes 
  tasks: 
  - name: Install Docker
    ansible.builtin.yum:
      name: docker 
      update_cache: yes
      state: latest
  - name: Start Docker
    ansible.builtin.systemd:
      name: docker
      state: started
      enabled: yes

- name: Add user to docker group 
  hosts: "{{ hostvars['localhost']['ec2_result'].instances[0].public_ip_address }}"
  become: yes
  tasks:
  - name: Add ec2-user to docker group 
    ansible.builtin.user:
      name: ec2-user
      group: docker
      append: yes
  - name: Reconnect to server session
    ansible.builtin.meta: reset_connection